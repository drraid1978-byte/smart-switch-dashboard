<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Smart Switch Dashboard</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />

    <!-- MQTT Library -->
    <script src="https://unpkg.com/mqtt@4.2.8/dist/mqtt.min.js"></script>

    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
      }

      .header {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 15px;
        padding: 30px;
        margin-bottom: 30px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        text-align: center;
      }

      .header-title {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 15px;
        margin-bottom: 10px;
      }

      .header-title h1 {
        color: #05d235;
        font-size: 32px;
        margin: 0;
      }

      .header p {
        color: #107303;
        font-size: 16px;
      }

      .toolbar {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 10px;
      }

      .search-box {
        flex: 1;
        min-width: 300px;
        position: relative;
      }

      .search-box input {
        width: 100%;
        padding: 12px 45px 12px 15px;
        border: 2px solid #e1e5e9;
        border-radius: 25px;
        font-size: 14px;
        background: #f8f9fa;
      }

      .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        font-size: 14px;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
      }

      .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
      }
      .btn-success {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
      }
      .btn-danger {
        background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        color: white;
      }
      .btn-warning {
        background: linear-gradient(135deg, #ffc107 0%, #ffca2c 100%);
        color: #333;
      }
      .btn-info {
        background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
        color: white;
      }

      /* Active State for Features */
      .btn-timer {
        background: linear-gradient(135deg, #ff9800 0%, #ff5722 100%);
        color: white;
        border: 1px solid transparent;
      }
      .btn-timer.active {
        box-shadow: 0 0 10px rgba(255, 87, 34, 0.6);
        border: 2px solid white;
        transform: scale(1.05);
      }
      .btn-schedule {
        background: linear-gradient(135deg, #00bcd4 0%, #009688 100%);
        color: white;
        border: 1px solid transparent;
      }
      .btn-schedule.active {
        box-shadow: 0 0 10px rgba(0, 188, 212, 0.6);
        border: 2px solid white;
        transform: scale(1.05);
      }

      .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      }

      /* STATS */
      .stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }
      .stat-card {
        background: white;
        padding: 20px;
        border-radius: 15px;
        text-align: center;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
      }
      .stat-value {
        font-size: 32px;
        font-weight: bold;
        color: #667eea;
      }
      .stat-label {
        color: #6c757d;
        font-size: 14px;
      }

      .devices-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        gap: 25px;
      }

      /* DEVICE CARD STYLES */
      .device-card {
        background: white;
        border-radius: 15px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        overflow: hidden;
        transition: all 0.3s ease;
        position: relative;
        display: flex;
        flex-direction: column;
      }
      .device-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
      }

      .device-header {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        padding: 20px;
        border-bottom: 1px solid #e9ecef;
      }
      .device-name {
        font-size: 20px;
        font-weight: bold;
        color: #2c3e50;
        margin-bottom: 8px;
      }
      .device-id {
        font-family: monospace;
        font-size: 13px;
        color: #6c757d;
        background: #f1f3f4;
        padding: 4px 8px;
        border-radius: 4px;
        cursor: pointer;
      }

      .device-info {
        padding: 20px;
        flex-grow: 1;
      }
      .info-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 6px 0;
        border-bottom: 1px solid #f1f3f4;
        font-size: 14px;
      }
      .info-row:last-child {
        border-bottom: none;
      }
      .info-label {
        color: #6c757d;
        font-weight: 600;
      }
      .info-value {
        color: #2c3e50;
        font-weight: 500;
      }

      .device-controls {
        padding: 20px;
        background: #fafafa;
        border-top: 1px solid #eee;
      }

      /* Toggle Switch Centered */
      .toggle-wrapper {
        display: flex;
        justify-content: center;
        margin-bottom: 15px;
      }
      .toggle-switch {
        position: relative;
        display: inline-block;
        width: 60px;
        height: 34px;
      }
      .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
      }
      .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ccc;
        transition: 0.4s;
        border-radius: 34px;
      }
      .slider:before {
        position: absolute;
        content: "";
        height: 26px;
        width: 26px;
        left: 4px;
        bottom: 4px;
        background-color: white;
        transition: 0.4s;
        border-radius: 50%;
      }
      input:checked + .slider {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
      }
      input:checked + .slider:before {
        transform: translateX(26px);
      }

      /* Feature Buttons Grid */
      .features-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        margin-bottom: 15px;
      }

      /* Action Buttons */
      .actions-row {
        display: flex;
        justify-content: center;
        gap: 10px;
        border-top: 1px solid #eee;
        padding-top: 15px;
      }
      .action-btn {
        background: none;
        border: 1px solid #ddd;
        border-radius: 5px;
        width: 35px;
        height: 35px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        color: #777;
        transition: all 0.2s;
      }
      .action-btn:hover {
        background: #eee;
        color: #333;
      }
      .action-btn.delete:hover {
        background: #fee;
        color: #dc3545;
        border-color: #dc3545;
      }

      /* MODAL STYLES */
      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        justify-content: center;
        align-items: center;
      }
      .modal-content {
        background: white;
        border-radius: 15px;
        padding: 30px;
        max-width: 500px;
        width: 90%;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        position: relative;
        animation: slideDown 0.3s ease;
      }
      @keyframes slideDown {
        from {
          transform: translateY(-20px);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }

      .close-modal {
        position: absolute;
        top: 15px;
        left: 15px;
        font-size: 24px;
        cursor: pointer;
        color: #aaa;
        transition: color 0.2s;
      }
      .close-modal:hover {
        color: #333;
      }

      .form-group {
        margin-bottom: 15px;
      }
      .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #2c3e50;
      }
      .form-group input,
      .form-group select {
        width: 100%;
        padding: 12px;
        border: 2px solid #e1e5e9;
        border-radius: 8px;
        font-size: 14px;
        background: #f8f9fa;
        box-sizing: border-box;
      }

      /* Day Selector */
      .days-container {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-bottom: 15px;
        justify-content: center;
      }
      .day-btn {
        padding: 8px 12px;
        border: 2px solid #e1e5e9;
        border-radius: 6px;
        cursor: pointer;
        background: white;
        font-size: 12px;
        transition: all 0.3s ease;
        flex: 1 0 30%;
        text-align: center;
        font-weight: bold;
      }
      .day-btn.selected {
        background: #00bcd4;
        color: white;
        border-color: #00bcd4;
        box-shadow: 0 2px 5px rgba(0, 188, 212, 0.3);
      }

      @media (max-width: 768px) {
        .devices-grid {
          grid-template-columns: 1fr;
        }
        .toolbar {
          flex-direction: column;
        }
      }
    </style>
  </head>

  <body>
    <div class="container">
      <!-- HEADER -->
      <div class="header">
        <div class="header-title">
          <h1>مؤسسة الليث للحلول والأنظمة الذكية</h1>
          <img
            src="https://github.com/drraid1978-byte/smart-switch-dashboard/blob/main/Office_Logo2.png?raw=true"
            alt="Allaith"
            width="170"
          />
        </div>
        <p><i class="fas fa-plug"></i> لوحة تحكم الأجهزة الذكية</p>
        <p>إدارة والتحكم في جميع مفاتيحك الذكية من مكان واحد</p>
      </div>

      <!-- STATISTICS -->
      <div class="stats">
        <div class="stat-card">
          <div class="stat-value" id="totalDevices">0</div>
          <div class="stat-label">
            <i class="fas fa-microchip"></i> إجمالي الأجهزة
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="onlineDevices">0</div>
          <div class="stat-label"><i class="fas fa-wifi"></i> أجهزة متصلة</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="onDevices">0</div>
          <div class="stat-label">
            <i class="fas fa-power-off"></i> أجهزة تعمل
          </div>
        </div>
      </div>

      <!-- TOOLBAR -->
      <div class="toolbar">
        <div class="search-box">
          <i
            class="fas fa-search"
            style="
              position: absolute;
              left: 15px;
              top: 50%;
              transform: translateY(-50%);
              color: #6c757d;
            "
          ></i>
          <input
            type="text"
            id="searchInput"
            placeholder="البحث عن جهاز..."
            onkeyup="searchDevices()"
          />
        </div>
        <button class="btn btn-primary" onclick="showAddDeviceModal()">
          <i class="fas fa-plus"></i> إضافة جهاز
        </button>
        <button
          class="btn btn-info"
          onclick="document.getElementById('importFileInput').click()"
        >
          <i class="fas fa-upload"></i> استيراد جهاز
        </button>
        <button class="btn btn-success" onclick="exportDevices()">
          <i class="fas fa-download"></i> تصدير الكل
        </button>
        <input
          type="file"
          id="importFileInput"
          style="display: none"
          accept=".json"
          onchange="importDevices(this)"
        />
      </div>

      <!-- DEVICES GRID -->
      <div class="devices-grid" id="devicesGrid"></div>
    </div>

<!-- ADD DEVICE MODAL -->
<div id="addDeviceModal" class="modal">
  <div class="modal-content">
    <span class="close-modal" onclick="closeModal('addDeviceModal')">&times;</span>
    <h2>إضافة جهاز جديد</h2>
    <div style="margin-top: 20px;">
        <div class="form-group"><label>اسم الجهاز</label><input type="text" id="newDeviceName"></div>
        <div class="form-group"><label>الغرفة</label><input type="text" id="newDeviceRoom"></div>
        
        <!-- NEW: IP ADDRESS INPUT -->
        <div class="form-group">
            <label>عنوان IP (اختياري للتحكم المحلي)</label>
            <input type="text" id="newDeviceIp" placeholder="مثال: 192.168.1.5">
            <small style="دخل "الـ" id="ipHint" style="display:block; margin-top:5px; color:#666; font-size:12px;">(أدخل المعرف (ID) للتحكم عبر الإنترنيت أو اتركه فارغا</small>
        </div>

        <!-- MODIFIED ID/TOKEN INPUTS -->
        <div class="form-group"><label>معرف الجهاز</label><input type="text" id="newDeviceId"></div>
        <div class="form-group"><label>رمز المصادقة</label><input type="password" id="newDeviceToken"></div>
        
        <button class="btn-action" onclick="addNewDevice()">إضافة</button>
    </div>
</div>

    <!-- TIMER MODAL -->
    <div id="timerModal" class="modal">
      <div class="modal-content">
        <span class="close-modal" onclick="closeModal('timerModal')"
          >&times;</span
        >
        <h2><i class="fas fa-clock" style="color: #ff9800"></i> ضبط المؤقت</h2>
        <div style="margin-top: 20px">
          <div class="form-group">
            <label>مدة المؤقت (ثواني):</label>
            <input
              type="number"
              id="timerDuration"
              min="1"
              max="86400"
              value="60"
            />
          </div>
          <div class="form-group">
            <label>عند الانتهاء:</label>
            <select id="timerState">
              <option value="true">تشغيل الجهاز (ON)</option>
              <option value="false">إطفاء الجهاز (OFF)</option>
            </select>
          </div>
          <div style="display: flex; gap: 10px; margin-top: 20px">
            <button
              class="btn btn-warning"
              onclick="confirmTimer()"
              style="flex: 1"
            >
              بدء المؤقت
            </button>
            <button
              class="btn btn-danger"
              onclick="cancelTimer()"
              style="flex: 1"
            >
              إلغاء المؤقت
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- SCHEDULE MODAL -->
    <div id="scheduleModal" class="modal">
      <div class="modal-content">
        <span class="close-modal" onclick="closeModal('scheduleModal')"
          >&times;</span
        >
        <h2>
          <i class="fas fa-calendar-alt" style="color: #00bcd4"></i> ضبط الجدولة
        </h2>
        <div style="margin-top: 20px">
          <div class="form-group">
            <label
              ><input type="checkbox" id="scheduleEnabled" /> تفعيل
              الجدولة</label
            >
          </div>
          <div class="form-group">
            <label>وقت التشغيل:</label>
            <input type="time" id="scheduleOnTime" />
          </div>
          <div class="form-group">
            <label>وقت الإيقاف:</label>
            <input type="time" id="scheduleOffTime" />
          </div>
          <label style="display: block; margin-bottom: 5px; font-weight: bold"
            >الأيام:</label
          >
          <div class="days-container" id="scheduleDaysContainer">
            <div class="day-btn" onclick="toggleDay(0)">الأحد</div>
            <div class="day-btn" onclick="toggleDay(1)">الإثنين</div>
            <div class="day-btn" onclick="toggleDay(2)">الثلاثاء</div>
            <div class="day-btn" onclick="toggleDay(3)">الأربعاء</div>
            <div class="day-btn" onclick="toggleDay(4)">الخميس</div>
            <div class="day-btn" onclick="toggleDay(5)">الجمعة</div>
            <div class="day-btn" onclick="toggleDay(6)">السبت</div>
          </div>
          <button
            class="btn btn-primary"
            onclick="confirmSchedule()"
            style="width: 100%"
          >
            حفظ الجدولة
          </button>
        </div>
      </div>
    </div>

    <!-- EDIT DEVICE MODAL -->
    <div id="editDeviceModal" class="modal">
      <div class="modal-content">
        <span class="close-modal" onclick="closeModal('editDeviceModal')"
          >&times;</span
        >
        <h2>تعديل بيانات الجهاز</h2>
        <div style="margin-top: 20px">
          <div class="form-group">
            <label>اسم الجهاز</label><input type="text" id="editDeviceName" />
          </div>
          <div class="form-group">
            <label>الغرفة</label><input type="text" id="editDeviceRoom" />
          </div>
          <div class="form-group">
            <label>معرف الجهاز (ID)</label
            ><input
              type="text"
              id="editDeviceId"
              readonly
              style="background: #eee"
            />
          </div>
          <div class="form-group">
            <label>رمز المصادقة</label
            ><input type="password" id="editDeviceToken" />
          </div>
          <button
            class="btn btn-primary"
            onclick="saveDeviceEdit()"
            style="width: 100%"
          >
            حفظ التغييرات
          </button>
        </div>
      </div>
    </div>

    <script>
  const mainSwitch = document.getElementById('mainSwitch'); // Global variable (removed local from modals)
  let devices = [];
  let clients = {}; // Stores active connections (Client objects)
  let currentEditIndex = -1;
  let currentScheduleDays = [false, false, false, false, false, false, false];
  let searchTerm = "";
  
  window.onload = function() {
      loadDevices();
      renderDevices();
      updateStats();
  };

  function loadDevices() {
      const saved = localStorage.getItem('smartSwitchDevices');
      if (saved) {
          devices = JSON.parse(saved);
          // Check objects have required fields
          devices.forEach(d => {
              if(!d.timer) d.timer = {enabled: false, remaining: 0};
              if(!d.schedule) d.schedule = {enabled: false, onTime: "08:00", offTime: "22:00", days: []};
              if(d.state === undefined) d.state = false;
              if(d.online === undefined) d.online = false;
              if(!d.clients) d.clients = {}; // Initialize clients object
          });
      }
  }

  function saveDevices() {
      localStorage.setItem('smartSwitchDevices', JSON.stringify(devices));
      updateStats();
  }

  // --- UPDATED: CONNECT TO DEVICE (PROTOCOL SNIFFING) ---
  function connectToDevice(index) {
      const d = devices[index];
      
      // Safety Check
      if (!d.id && !d.ip) {
          // Prompt to fill data
          openEditModal(index);
          const idInput = document.getElementById('editDeviceId');
          const tokenInput = document.getElementById('editDeviceToken');
          idInput.style.borderColor = "red";
          tokenInput.style.borderColor = "red";
          idInput.placeholder = "مطلوب معرف الجهاز";
          return;
      }

      // Disconnect existing
      if (clients[d.id] && clients[d.id].connected) {
          try {
            clients[d.id].end(); // Try clean close
            // Wait briefly for buffer to clear
            setTimeout(() => { delete clients[d.id]; }, 200);
          } catch(e) { delete clients[d.id]; }
      }

      // LOGIC: HTTP vs MQTT
      const isIp = (d.ip && d.ip.includes('.')); // Simple check for IP address
      
      if (isIp) {
          // CASE 1: LOCAL IP CONTROL (HTTP)
          console.log(`Connecting to Local Device: ${d.ip}`);
          connectToHTTP(index);
      } else {
          // CASE 2: CLOUD CONTROL (MQTT)
          console.log(`Connecting to Cloud Device: ${d.id}`);
          connectToMQTT(index);
      }
  }

  function connectToHTTP(index) {
      const d = devices[index];
      
      // Use PubSubClient for HTTP connection
      // Note: PubSubClient handles standard TCP. 
      clients[d.id] = mqtt.connect(`http://${d.ip}`, 1883);
      
      clients[d.id].on('message', (t, m) => {
          const payload = m.toString();
          try {
              const data = JSON.parse(payload);
              // Match ESP JSON structure
              if (data.relayState !== undefined) {
                  d.state = data.relayState;
                  renderDevices(); // Update UI
              }
          } catch(e) { console.error("Parse Error", e); }
      });
      
      clients[d.id].on('connect', () => {
          console.log("HTTP Connected to " + d.name);
          d.online = true;
          publishStatus(index); // Tell device we are online
          requestStatus(index); // Get initial status
      });
      
      clients[d.id].on('error', () => {
          console.error("HTTP Connection Failed");
          d.online = false;
          renderDevices();
      });
      
      clients[d.id].on('offline', () => {
          console.log("HTTP Disconnected");
          d.online = false;
          renderDevices();
      });
  }

  function connectToMQTT(index) {
      const d = devices[index];
      
      // STANDARD MQTT PORT 1883
      // NOTE: Ignoring WSS 8884 in your original code. 
      // If your broker requires WSS:8884/mqtt, you must use wss://broker.hivemq.com:8884/mqtt
      // PubSubClient handles WSS via wss:// prefix.
      clients[d.id] = mqtt.connect(`mqtt://broker.hivemq.com`, 1883, {
          clientId: 'web-' + d.id,
          clean: true,
          keepalive: 60
      });
      
      clients[d.id].on('message', (t, m) => {
          const payload = m.toString();
          try {
              const data = JSON.parse(payload);
              if (data.relayState !== undefined) {
                  d.state = data.relayState;
                  renderDevices();
              }
              if (data.timer) {
                  d.timer = data.timer;
                  renderDevices();
              }
          } catch(e) { console.error("Parse Error", e); }
      });
      
      clients[d.id].on('connect', () => {
          console.log("MQTT Connected: " + d.name);
          d.online = true;
          const topics = [
              "laithsmartswitch/remote/" + d.id + "/status",
              "laithsmartswitch/remote/" + d.id + "/control"
          ];
          topics.forEach(t => clients[d.id].subscribe(t, { qos: 1 });
          requestStatus(index);
      });
      
      clients[d.id].on('offline', () => {
          console.log("MQTT Disconnected");
          d.online = false;
          renderDevices();
      });
      
      clients[d.id].on('error', (err) => {
          console.log("MQTT Error: ", err.message);
          d.online = false;
          renderDevices();
      });
  }

  // --- LOGIC FUNCTIONS (API) ---

  function addNewDevice() {
      const name = document.getElementById('newDeviceName').value;
      const room = document.getElementById('newDeviceRoom').value;
      const ip = document.getElementById('newDeviceIp').value;
      const id = document.getElementById('newDeviceId').value;
      const token = document.getElementById('newDevice').token.value; // Fixed typo
  
  if (!name || !id) return alert("الرجاء تعبء الاسم و المعرف");
  if(devices.find(d=>d.id===id)) return alert("المعرف موجود مسبقاً");
  
  devices.push({
      name, room, id, token,
      state: false, online: false, 
      ip: ip, // Added IP
      rssi: '-', 
      timer: {enabled: false, remaining: 0}, 
      schedule: {enabled: false, onTime: "08:00", offTime: "22:00", days: []}
  });
  saveDevices();
  closeModal('addDeviceModal');
}

function connectToDevice(index) { 
  // Uses Protocol Sniffing to decide HTTP or MQTT automatically
  const d = devices[index];

  // Force Disconnect if connection method changed (e.g. User changed IP -> ID)
  if (clients[d.id] && clients[d.id].connected) {
      if ((d.ip && d.ip.includes('.') && clients[d.id].protocol !== 'HTTP') ||
          (!d.ip && clients[d.id].protocol === 'HTTP')) {
            clients[d.id].end();
            delete clients[d.id];
      }
  }

  const useHttp = (d.ip && d.ip.includes('.'));
  
  if (useHttp) {
      // Use PubSubClient for HTTP
      // Use port 80 or 1883 (Standard MQTT port, compatible with most brokers)
      clients[d.id] = mqtt.connect(`http://${d.ip}`, 80);
      
      clients[d.id].on('message', (t, m) => {
          const payload = m.toString();
          try {
              const data = JSON.parse(payload);
              if (data.relayState !== undefined) {
                  d.state = data.relayState;
                  renderDevices();
              }
          } catch(e) { }
      });
      
      clients[d.id].on('connect', () => {
          console.log("HTTP Connected");
          d.online = true;
          publishStatus(index);
          requestStatus(index);
      });
      
      clients[d.id].on('offline', () => {
          d.online = false;
          renderDevices();
      });

  } else {
      // Use PubSubClient for MQTT (Standard Port 1883)
      // Use mqtt:// prefix
      clients[d.id] = mqtt.connect(`mqtt://broker.hivemq.com`, 1883, {
          clientId: 'web-' + d.id,
          clean: true,
          keepalive: 60
      });
      
      clients[d.id].on('message', (t, m) => {
          const payload = m.toString();
          try {
              const data = JSON.parse(payload);
              if (data.relayState !== undefined) {
                  d.state = data.relayState;
                  renderDevices();
              }
              if (data.timer) {
                  d.timer = data.timer;
                  renderDevices();
              }
          } catch(e) { }
      });
      
      clients[d.id].on('connect', () => {
          console.log("MQTT Connected");
          d.online = true;
          const topics = [
              "laithsmartswitch/remote/" + d.id + "/status",
              "laithparent/remote/" + d.id + "/control"
          ];
          topics.forEach(t => {
              clients[d.id].subscribe(t, { qos: 1 });
          });
          requestStatus(index);
      });
      
      clients[d.id].on('offline', () => {
          console.log("MQTT Offline");
          d.online = false;
          renderDevices();
      });
      
      clients[d.id].on('error', (err) => {
          console.log("MQTT Error:", err.message);
          d.online = false;
          renderDevices();
      });
  }
}

function publishStatus(index) {
  const d = devices[index];
  if (clients[d.id] && clients[d.id].connected) {
      const topic = "laithsmartswitch/remote/" + d.id + "/status";
      // Payload structure matching ESP's `handleStatus`
      const json = "{\"relay\":" + String(d.state ? 1 : 0);
      
      // Include token for verification
      if (d.token) {
          json += ",\"token\":" + d.token; 
      }
      json += "}";
      
      try {
          // PubSubClient handles JSON.stringify via MQTT
          clients[d.id].publish(topic, json);
      } catch(e) {
          console.error("Publish Failed", e);
      }
  }
}

function requestStatus(index) {
  const d = devices[index];
  if (clients[d.id] && clients[d.id].connected) {
      clients[d.id].send("laithsmartswitch/remote/" + d.id + "/status");
  }
}

// ... rest of your existing code (renderDevices, addNewDevice, etc.) ...

    <p style="color: rgb(25, 255, 9)" align="center">
      للمعلومات الاتصال بمؤسسة الليث
    </p>
    <p style="color: rgb(25, 255, 9)" align="center">Watsapp ☏ : 07763755336</p>
  </body>
</html>
